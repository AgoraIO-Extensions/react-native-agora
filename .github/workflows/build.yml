name: Build API Example

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        newArch: [false, true]
    env:
      TURBO_CACHE_DIR: .turbo/android
      ORG_GRADLE_PROJECT_newArchEnabled: ${{ matrix.newArch }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup
        uses: ./.github/actions/setup

      - name: Build Android
        uses: ./.github/actions/build-android
        with:
          new-arch: ${{ matrix.newArch }}
          turbo-cache-dir: ${{ env.TURBO_CACHE_DIR }}
          build-task: 'build:android'
          force-build: 'true'

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: AgoraRtcNgExample-Android-${{ matrix.newArch && 'NewArch' || 'OldArch' }}-${{ github.run_id }}
          path: |
            example/android/app/build/outputs/apk/release/*.apk
          if-no-files-found: error

  build-ios:
    runs-on: macos-latest
    strategy:
      matrix:
        newArch: [false, true]
    env:
      TURBO_CACHE_DIR: .turbo/ios
      RCT_NEW_ARCH_ENABLED: ${{ matrix.newArch }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup
        uses: ./.github/actions/setup

      - name: Build iOS
        uses: ./.github/actions/build-ios
        with:
          new-arch: ${{ matrix.newArch }}
          turbo-cache-dir: ${{ env.TURBO_CACHE_DIR }}
          build-task: 'build:ios'
          force-build: 'true'

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: AgoraRtcNgExample-iOS-${{ matrix.newArch && 'NewArch' || 'OldArch' }}-${{ github.run_id }}
          path: |
            example/ios/*.ipa
          if-no-files-found: error

      - name: Upload dSYM
        uses: actions/upload-artifact@v4
        with:
          name: AgoraRtcNgExampleSymbol-${{ matrix.newArch && 'NewArch' || 'OldArch' }}-${{ github.run_id }}
          path: |
            example/ios/*.dSYM.zip
          if-no-files-found: error

  notification:
    runs-on: ubuntu-latest
    needs: [build-android, build-ios]
    steps:
      - run: |
          curl -X POST "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=${{ secrets.WECHAT_KEY }}" -d '{"msgtype":"text","text":{"content":"ReactNative Example:\n${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\nDownload Link:\nhttps://nightly.link/${{ github.repository }}/actions/runs/${{ github.run_id }}"}}'
